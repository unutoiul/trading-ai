<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Pattern Analysis</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding-top: 20px;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .crypto-pair {
        margin: 5px;
        padding: 8px 12px;
        background-color: #f8f9fa;
        border-radius: 5px;
        display: inline-block;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .crypto-pair.selected {
        background-color: #0d6efd;
        color: white;
      }
      .crypto-pair:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      #dateControls {
        margin: 20px 0;
      }
      #fetchedDataList {
        margin-top: 20px;
      }
      .data-file {
        padding: 10px;
        margin-bottom: 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .data-file button {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">Crypto Pattern Analysis</h1>

      <div class="card mb-4">
        <div class="card-header">
          <h2 class="h5 mb-0">1. Select Crypto Pairs & Date Range</h2>
        </div>
        <div class="card-body">
          <div id="pairSelection">
            <div class="mb-3">
              <label class="form-label">Select pairs to analyze:</label>
              <div class="input-group mb-3">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search pairs..."
                  id="pairSearchInput"
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="clearSearchBtn"
                >
                  Clear
                </button>
              </div>
              <div id="availablePairs" class="d-flex flex-wrap"></div>
              <div class="loader" id="pairsLoader"></div>
            </div>
          </div>

          <div id="dateControls" class="row">
            <div class="col-md-5">
              <label for="startDate" class="form-label">Start Date:</label>
              <input
                type="datetime-local"
                class="form-control"
                id="startDate"
              />
            </div>
            <div class="col-md-5">
              <label for="endDate" class="form-label">End Date:</label>
              <input type="datetime-local" class="form-control" id="endDate" />
            </div>
            <div class="col-md-2">
              <label for="timeframe" class="form-label">Timeframe:</label>
              <select class="form-select" id="timeframe">
                <option value="1m" selected>1 minute</option>
                <option value="5m">5 minutes</option>
                <option value="15m">15 minutes</option>
                <option value="1h">1 hour</option>
              </select>
            </div>
          </div>

          <button id="fetchDataBtn" class="btn btn-primary mt-3">
            Fetch Selected Data
          </button>
          <div class="loader" id="fetchLoader"></div>
          <div class="card mt-3" id="fetchLogCard" style="display: none">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">Fetch Logs</h5>
              <button
                class="btn btn-sm btn-outline-secondary"
                id="clearFetchLogsBtn"
              >
                Clear
              </button>
            </div>
            <div class="card-body">
              <pre
                id="fetchLogs"
                style="
                  height: 300px;
                  overflow-y: auto;
                  background-color: #f8f9fa;
                  padding: 10px;
                  border-radius: 5px;
                  font-size: 0.85rem;
                "
              ></pre>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h2 class="h5 mb-0">2. Downloaded Data</h2>
        </div>
        <div class="card-body">
          <div id="fetchedDataList">
            <p>No data fetched yet. Select pairs and date range above.</p>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h2 class="h5 mb-0">3. Run Analysis</h2>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label for="btcFileSelect" class="form-label"
                >Select BTC File:</label
              >
              <select class="form-select" id="btcFileSelect">
                <option value="">-- Select BTC file --</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="altFileSelect" class="form-label"
                >Select Altcoin File:</label
              >
              <select class="form-select" id="altFileSelect">
                <option value="">-- Select altcoin file --</option>
              </select>
            </div>
          </div>
          <button id="runAnalysisBtn" class="btn btn-success mt-3" disabled>
            Run Pattern Analysis
          </button>
          <button id="viewResultsBtn" class="btn btn-primary mt-3 ms-2">
            View Analysis Results
          </button>
          <button
            id="reloadFilesBtn"
            class="btn btn-outline-secondary mt-3 ms-2"
          >
            Reload File List
          </button>
          <div class="loader" id="analysisLoader"></div>
          <div id="analysisResult" class="mt-3"></div>
          <div class="card mt-3" id="logCard" style="display: none">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">Analysis Logs</h5>
              <button
                class="btn btn-sm btn-outline-secondary"
                id="clearLogsBtn"
              >
                Clear
              </button>
            </div>
            <div class="card-body">
              <pre
                id="analysisLogs"
                style="
                  height: 300px;
                  overflow-y: auto;
                  background-color: #f8f9fa;
                  padding: 10px;
                  border-radius: 5px;
                  font-size: 0.85rem;
                "
              ></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Add this after the "Run Analysis" card -->
      <div class="card mb-4">
        <div class="card-header">
          <h2 class="h5 mb-0">4. Strategy Builder</h2>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <strong>Note:</strong> Generate a Pine Script strategy based on
            pattern and ML analysis results
          </div>

          <!-- Add this to the Strategy Builder card body, before the strategy type selection -->
          <div class="mb-3">
            <label class="form-label">Analysis Report:</label>
            <select class="form-select" id="reportSelect">
              <option value="">Loading reports...</option>
            </select>
            <button
              id="loadReportsBtn"
              class="btn btn-sm btn-outline-secondary mt-2"
            >
              Refresh Reports List
            </button>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Strategy Type:</label>
                <select class="form-select" id="strategyType">
                  <option value="momentum">BTC Momentum Strategy</option>
                  <option value="pattern">Pattern Recognition</option>
                  <option value="ml">ML-Based Strategy</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Risk Per Trade (%):</label>
                <input
                  type="range"
                  class="form-range"
                  id="riskPerTrade"
                  min="1"
                  max="100"
                  step="1"
                  value="1"
                />
                <div class="d-flex justify-content-between">
                  <small>1%</small>
                  <small id="riskValue">1%</small>
                  <small>100%</small>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Strategy Parameters:</label>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="useStopLoss"
                    checked
                  />
                  <label class="form-check-label">Use Stop Loss</label>
                </div>
                <div class="input-group mb-2">
                  <span class="input-group-text">SL %</span>
                  <input
                    type="number"
                    class="form-control"
                    id="stopLossPercent"
                    value="5"
                    min="1"
                    max="20"
                  />
                </div>

                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="useTakeProfit"
                    checked
                  />
                  <label class="form-check-label">Use Take Profit</label>
                </div>
                <div class="input-group mb-2">
                  <span class="input-group-text">TP %</span>
                  <input
                    type="number"
                    class="form-control"
                    id="takeProfitPercent"
                    value="10"
                    min="1"
                    max="50"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2">
            <button
              id="generateStrategyBtn"
              class="btn btn-primary mt-3"
              disabled
            >
              Generate Pine Script Strategy
            </button>
            <div class="form-check form-switch mt-4 ms-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="useClaudeAI"
                checked
              />
              <label class="form-check-label">Use AI Claude 3.7 Sonnet</label>
            </div>
          </div>

          <div class="loader" id="strategyLoader" style="display: none"></div>
          <div id="strategyResult" class="mt-3"></div>
        </div>
      </div>
    </div>

    <script>
      // Set default date range (last 30 days)
      window.onload = function () {
        const now = new Date();
        const endDate = now.toISOString().slice(0, 16);
        document.getElementById("endDate").value = endDate;

        now.setDate(now.getDate() - 30);
        const startDate = now.toISOString().slice(0, 16);
        document.getElementById("startDate").value = startDate;

        // Fetch available pairs
        loadAvailablePairs();

        // Load existing data files
        loadExistingDataFiles();
      };

      // Modify the loadAvailablePairs function
      function loadAvailablePairs() {
        const pairsContainer = document.getElementById("availablePairs");
        const loader = document.getElementById("pairsLoader");

        pairsContainer.innerHTML = "";
        loader.style.display = "block";

        fetch("/available_pairs")
          .then((response) => response.json())
          .then((data) => {
            loader.style.display = "none";

            if (data.error) {
              pairsContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
              return;
            }

            // Create a container for the pairs
            const pairsWrapper = document.createElement("div");
            pairsWrapper.className = "d-flex flex-wrap";
            pairsContainer.appendChild(pairsWrapper);

            // Add a container for the "View More" button
            const buttonContainer = document.createElement("div");
            buttonContainer.className = "w-100 text-center mt-3";
            pairsContainer.appendChild(buttonContainer);

            // Show only initial set of pairs and hide the rest
            const initialDisplayCount = 12; // Show first 12 pairs
            let hiddenPairs = [];

            data.pairs.forEach((pair, index) => {
              const pairEl = document.createElement("div");
              pairEl.className = "crypto-pair";
              pairEl.textContent = pair;
              pairEl.setAttribute("data-pair", pair);
              pairEl.onclick = function () {
                this.classList.toggle("selected");
                updateRunButton();
              };

              // Show only some pairs initially
              if (index >= initialDisplayCount) {
                pairEl.style.display = "none";
                hiddenPairs.push(pairEl);
              }

              pairsWrapper.appendChild(pairEl);
            });

            // Add "View More" button if there are hidden pairs
            if (hiddenPairs.length > 0) {
              const viewMoreBtn = document.createElement("button");
              viewMoreBtn.className = "btn btn-outline-primary mt-2";
              viewMoreBtn.textContent = `View All Pairs (${hiddenPairs.length} more)`;
              viewMoreBtn.onclick = function () {
                hiddenPairs.forEach((pair) => {
                  pair.style.display = "inline-block";
                });
                this.style.display = "none";
              };
              buttonContainer.appendChild(viewMoreBtn);
            }

            // Pre-select BTC and DOGE
            const btcEl = document.querySelector('[data-pair="BTC/USDT"]');
            const dogeEl = document.querySelector('[data-pair="DOGE/USDT"]');
            if (btcEl) btcEl.classList.add("selected");
            if (dogeEl) dogeEl.classList.add("selected");

            // When searching, ensure all pairs are visible
            document
              .getElementById("pairSearchInput")
              .addEventListener("input", function () {
                const searchTerm = this.value.toLowerCase();

                // Hide the view more button when searching
                if (buttonContainer.firstChild) {
                  buttonContainer.firstChild.style.display = searchTerm
                    ? "none"
                    : "inline-block";
                }

                document.querySelectorAll(".crypto-pair").forEach((pair) => {
                  const pairName = pair.textContent.toLowerCase();
                  if (pairName.includes(searchTerm)) {
                    pair.style.display = "inline-block";
                  } else {
                    pair.style.display = "none";
                  }
                });
              });
          })
          .catch((error) => {
            loader.style.display = "none";
            pairsContainer.innerHTML = `<div class="alert alert-danger">Error loading pairs: ${error}</div>`;
          });
      }

      // Add these variables at the top of your script
      let logSource = null;
      let analysisComplete = false;
      let fetchLogSource = null;
      let fetchComplete = false;

      // Fetch data for selected pairs
      document
        .getElementById("fetchDataBtn")
        .addEventListener("click", function () {
          const selectedPairs = Array.from(
            document.querySelectorAll(".crypto-pair.selected")
          ).map((el) => el.getAttribute("data-pair"));

          if (selectedPairs.length === 0) {
            alert("Please select at least one crypto pair");
            return;
          }

          const startDate = document.getElementById("startDate").value;
          const endDate = document.getElementById("endDate").value;
          const timeframe = document.getElementById("timeframe").value;

          if (!startDate || !endDate) {
            alert("Please select start and end dates");
            return;
          }

          const loader = document.getElementById("fetchLoader");
          const logCard = document.getElementById("fetchLogCard");
          const logsDiv = document.getElementById("fetchLogs");

          // Reset the UI
          loader.style.display = "block";
          fetchComplete = false;
          logsDiv.textContent = "Connecting to fetch log stream...\n";
          logCard.style.display = "block";

          // Close any existing EventSource
          if (fetchLogSource) {
            fetchLogSource.close();
          }

          // Start listening for logs
          fetchLogSource = new EventSource("/fetch_logs");

          fetchLogSource.onmessage = function (event) {
            if (event.data === "heartbeat") return;

            // Log all messages to help debugging
            console.log("Fetch log:", event.data);

            // Change this line from exact match to includes()
            if (event.data.includes("FETCH_COMPLETE")) {
              logsDiv.textContent +=
                "FETCH_COMPLETE received, checking results...\n";
              fetchComplete = true;
              checkFetchResult();
              return;
            }

            // Similarly, change this check to use includes() instead of startsWith()
            if (event.data.includes("FETCH_ERROR:")) {
              const errorMessage = event.data
                .substring(
                  event.data.indexOf("FETCH_ERROR:") + "FETCH_ERROR:".length
                )
                .trim();
              alert(`Error fetching data: ${errorMessage}`);
              loader.style.display = "none";
              fetchLogSource.close();
              return;
            }

            // Add log message
            logsDiv.textContent += event.data + "\n";
            // Auto-scroll to bottom
            logsDiv.scrollTop = logsDiv.scrollHeight;
          };

          fetchLogSource.onerror = function () {
            logsDiv.textContent += "Log connection lost. Reconnecting...\n";
            fetchLogSource.close();
          };

          // Start the fetch
          fetch("/fetch_data", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              pairs: selectedPairs,
              start_date: startDate,
              end_date: endDate,
              timeframe: timeframe,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                alert(`Error: ${data.error}`);
                loader.style.display = "none";
                if (fetchLogSource) fetchLogSource.close();
              }
            })
            .catch((error) => {
              loader.style.display = "none";
              alert(`Error: ${error}`);
              if (fetchLogSource) fetchLogSource.close();
            });
        });

      // Add a function to check fetch results
      function checkFetchResult() {
        if (!fetchComplete) return;

        const loader = document.getElementById("fetchLoader");
        const logCard = document.getElementById("fetchLogCard");
        const fetchedDataList = document.getElementById("fetchedDataList");

        // Always stop the spinner at the beginning of the function to ensure it stops
        loader.style.display = "none";

        // Show debugging message in the logs
        const logsDiv = document.getElementById("fetchLogs");
        logsDiv.textContent += "Fetching complete - checking for results...\n";

        fetch("/fetch_status")
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `Server returned ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.status === "complete") {
              // Log success in the logs div
              logsDiv.textContent += `Success! Got ${
                data.results ? data.results.length : 0
              } results\n`;
              logsDiv.textContent +=
                "✅ Download completed successfully. You can keep this log open for reference.\n";
              logsDiv.textContent +=
                "------------------------------------------------\n";

              // Process the results
              if (data.results && data.results.length > 0) {
                displayFetchedData(data.results);
                updateFileSelectors(data.results);

                // Also refresh the full file list to include these files
                loadExistingDataFiles();
              } else {
                fetchedDataList.innerHTML =
                  "<div class='alert alert-warning'>No data files were retrieved</div>";
              }
            } else {
              // Show error message
              logsDiv.textContent += `Error: ${data.message}\n`;
              fetchedDataList.innerHTML = `<div class='alert alert-warning'>${data.message}</div>`;
            }

            if (fetchLogSource) fetchLogSource.close();
          })
          .catch((error) => {
            logsDiv.textContent += `Error checking fetch status: ${error}\n`;
            fetchedDataList.innerHTML = `<div class='alert alert-danger'>Error checking fetch status: ${error}</div>`;
            if (fetchLogSource) fetchLogSource.close();
          });
      }

      // Display fetched data files
      function displayFetchedData(results) {
        const container = document.getElementById("fetchedDataList");

        if (results.length === 0) {
          container.innerHTML = "<p>No data fetched.</p>";
          return;
        }

        container.innerHTML = "<h4>Fetched Data Files:</h4>";

        results.forEach((result) => {
          const fileEl = document.createElement("div");
          fileEl.className = "data-file";

          if (result.error) {
            fileEl.innerHTML = `<span>${result.symbol}: Error - ${result.error}</span>`;
          } else {
            fileEl.innerHTML = `
                        <span>${result.display_name}</span>
                        <button class="btn btn-sm btn-primary download-btn" 
                                data-filename="${result.filename}">Download</button>
                    `;
          }

          container.appendChild(fileEl);
        });

        // Add download event listeners
        document.querySelectorAll(".download-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const filename = this.getAttribute("data-filename");
            window.location.href = `/download/${filename}`;
          });
        });
      }

      // Update this function to directly update the dropdowns
      function loadExistingDataFiles() {
        const container = document.getElementById("fetchedDataList");
        container.innerHTML = "<p>Loading existing data files...</p>";

        console.log("Attempting to load existing data files...");

        fetch("/list_data_files")
          .then((response) => {
            console.log("Received response:", response.status);
            if (!response.ok) {
              throw new Error(
                `Server returned ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            console.log("Data received:", data);

            if (data.error) {
              container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
              return;
            }

            if (!data.files) {
              container.innerHTML = `<div class="alert alert-warning">No files property in response</div>`;
              console.error("Unexpected response format:", data);
              return;
            }

            if (data.files.length > 0) {
              // Display files in fetchedDataList
              container.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h4>Available Data Files:</h4>
                  <button id="refreshFilesBtn" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                  </button>
                </div>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>Symbol</th>
                        <th>Date Information</th>
                        <th>Size</th>
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="filesTableBody">
                    </tbody>
                  </table>
                </div>
              `;

              const tableBody = document.getElementById("filesTableBody");

              // Add rows to the table
              data.files.forEach((file) => {
                const row = document.createElement("tr");

                // Extract date from display_name or created
                const dateStr = file.created || "";

                // Replace the inner HTML of each row to include a delete button
                row.innerHTML = `
                  <td>${file.symbol}</td>
                  <td>
                    <div class="d-flex flex-column">
                      <small class="text-primary"><strong>Range:</strong> ${
                        extractDateRange(file.filename) || "Unknown"
                      }</small>
                      <small class="text-muted"><strong>Created:</strong> ${dateStr}</small>
                    </div>
                  </td>
                  <td>${file.size || "Unknown"}</td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm" role="group">
                      <button class="btn btn-outline-secondary download-file-btn" 
                              data-filename="${file.filename}">
                        Download
                      </button>
                      <button class="btn btn-outline-danger delete-file-btn" 
                              data-filename="${file.filename}">
                        Delete
                      </button>
                    </div>
                  </td>
                `;

                tableBody.appendChild(row);
              });

              setupDeleteButtons();

              document.querySelectorAll(".download-file-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                  const filename = this.getAttribute("data-filename");
                  window.location.href = `/download/${filename}`;
                });
              });

              // Add refresh button handler
              document
                .getElementById("refreshFilesBtn")
                .addEventListener("click", function () {
                  loadExistingDataFiles();
                });

              // ALSO populate the dropdowns
              const btcSelect = document.getElementById("btcFileSelect");
              const altSelect = document.getElementById("altFileSelect");

              // Keep only the first option
              btcSelect.innerHTML =
                '<option value="">-- Select BTC file --</option>';
              altSelect.innerHTML =
                '<option value="">-- Select altcoin file --</option>';

              // Filter for BTC and other files
              const btcFiles = data.files.filter(
                (file) =>
                  file.symbol && file.symbol.toUpperCase().includes("BTC")
              );

              const altFiles = data.files.filter(
                (file) =>
                  file.symbol && !file.symbol.toUpperCase().includes("BTC")
              );

              console.log("Found files:", {
                btc: btcFiles.length,
                alt: altFiles.length,
              });

              // Add BTC files to dropdown
              btcFiles.forEach((file) => {
                const option = document.createElement("option");
                option.value = file.filepath;
                option.textContent = file.display_name || file.symbol;
                btcSelect.appendChild(option);
              });

              // Add altcoin files to dropdown
              altFiles.forEach((file) => {
                const option = document.createElement("option");
                option.value = file.filepath;
                option.textContent = file.display_name || file.symbol;
                altSelect.appendChild(option);
              });

              // If we have both BTC and alt files, select the first ones
              if (btcFiles.length > 0) {
                btcSelect.value = btcFiles[0].filepath;
              }

              if (altFiles.length > 0) {
                altSelect.value = altFiles[0].filepath;
              }

              // Update run button state
              updateRunButton();
            } else {
              container.innerHTML = `
                <div class="alert alert-info">
                  No data files found. Use the form above to fetch data.
                </div>
              `;
            }
          })
          .catch((error) => {
            console.error("Error loading files:", error);
            container.innerHTML = `
              <div class="alert alert-danger">
                Error loading data files: ${error}
                <button id="retryLoadBtn" class="btn btn-sm btn-outline-primary mt-2">
                  Retry
                </button>
              </div>
            `;

            document
              .getElementById("retryLoadBtn")
              .addEventListener("click", function () {
                loadExistingDataFiles();
              });
          });
      }

      // Update file selectors for analysis
      function updateFileSelectors(results) {
        const btcSelect = document.getElementById("btcFileSelect");
        const altSelect = document.getElementById("altFileSelect");

        // Keep only the first option
        btcSelect.innerHTML = '<option value="">-- Select BTC file --</option>';
        altSelect.innerHTML =
          '<option value="">-- Select altcoin file --</option>';

        results.forEach((result) => {
          if (!result.error) {
            const option = document.createElement("option");
            option.value = result.filename;
            option.textContent = result.display_name;

            if (result.symbol === "BTC/USDT") {
              btcSelect.appendChild(option);
              btcSelect.value = result.filename;
            } else {
              altSelect.appendChild(option);
              // If it's DOGE, select it by default
              if (result.symbol === "DOGE/USDT") {
                altSelect.value = result.filename;
              }
            }
          }
        });

        updateRunButton();
      }

      // Enable/disable run analysis button
      function updateRunButton() {
        const btcFile = document.getElementById("btcFileSelect").value;
        const altFile = document.getElementById("altFileSelect").value;

        document.getElementById("runAnalysisBtn").disabled = !(
          btcFile && altFile
        );
      }

      // File selector change event
      document
        .getElementById("btcFileSelect")
        .addEventListener("change", updateRunButton);
      document
        .getElementById("altFileSelect")
        .addEventListener("change", updateRunButton);

      // Run analysis
      document
        .getElementById("runAnalysisBtn")
        .addEventListener("click", function () {
          const btcFile = document.getElementById("btcFileSelect").value;
          const altFile = document.getElementById("altFileSelect").value;

          if (!btcFile || !altFile) {
            alert("Please select both BTC and altcoin files");
            return;
          }

          const loader = document.getElementById("analysisLoader");
          const resultDiv = document.getElementById("analysisResult");
          const logCard = document.getElementById("logCard");
          const logsDiv = document.getElementById("analysisLogs");

          // Reset the UI
          loader.style.display = "block";
          resultDiv.innerHTML = "";
          analysisComplete = false;
          logsDiv.textContent = "Connecting to log stream...\n";
          logCard.style.display = "block";

          // Close any existing EventSource
          if (logSource) {
            logSource.close();
          }

          // Start listening for logs
          logSource = new EventSource("/analysis_logs");

          logSource.onmessage = function (event) {
            if (event.data === "heartbeat") return;

            if (event.data.includes("ANALYSIS_COMPLETE")) {
              analysisComplete = true;
              checkAnalysisResult();
              return;
            }

            if (event.data.startsWith("ANALYSIS_ERROR:")) {
              const errorMessage = event.data
                .substring("ANALYSIS_ERROR:".length)
                .trim();
              resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${errorMessage}</div>`;
              loader.style.display = "none";
              logSource.close();
              return;
            }

            // Add log message
            logsDiv.textContent += event.data + "\n";
            // Auto-scroll to bottom
            logsDiv.scrollTop = logsDiv.scrollHeight;
          };

          logSource.onerror = function () {
            logsDiv.textContent += "Log connection lost. Reconnecting...\n";
            logSource.close();
          };

          // Run the analysis
          fetch("/run_analysis", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              btc_file: btcFile,
              alt_file: altFile,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                loader.style.display = "none";
                if (logSource) logSource.close();
              }
            })
            .catch((error) => {
              loader.style.display = "none";
              resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
              if (logSource) logSource.close();
            });
        });

      // Function to check if analysis is complete
      function checkAnalysisResult() {
        if (!analysisComplete) return;

        const loader = document.getElementById("analysisLoader");
        const resultDiv = document.getElementById("analysisResult");
        const strategyBtn = document.getElementById("generateStrategyBtn");

        fetch("/analysis_result")
          .then((response) => response.json())
          .then((data) => {
            loader.style.display = "none";

            if (data.status === "complete") {
              // Success message
              resultDiv.innerHTML = `
                <div class="alert alert-success">
                  Analysis complete! You can now view the results or generate a strategy.
                </div>
              `;

              // Check for strategy_params.json to enable the strategy button
              fetch("/get_optimized_strategy")
                .then((response) => response.json())
                .then((stratData) => {
                  if (stratData.exists) {
                    // Enable the generate strategy button
                    strategyBtn.disabled = false;

                    // Add strategy metrics if available
                    resultDiv.innerHTML += `
                      <div class="alert alert-info mt-3">
                        <strong>Strategy Optimization Results:</strong><br>
                        Win Rate: ${stratData.metrics.win_rate}<br>
                        Profit Factor: ${stratData.metrics.profit_factor}<br>
                        Stop Loss: ${stratData.metrics.stop_loss}<br>
                        Take Profit: ${stratData.metrics.take_profit}
                      </div>
                    `;
                  }
                })
                .catch((err) =>
                  console.error("Error checking for optimized strategy:", err)
                );
            } else {
              resultDiv.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
            }

            // Close log stream but keep the logs visible
            if (logSource) logSource.close();
          })
          .catch((error) => {
            loader.style.display = "none";
            resultDiv.innerHTML = `<div class="alert alert-danger">Error checking result: ${error}</div>`;
            if (logSource) logSource.close();
          });
      }

      // Clear logs button
      document
        .getElementById("clearLogsBtn")
        .addEventListener("click", function () {
          document.getElementById("analysisLogs").textContent = "";
        });

      // Add search functionality for crypto pairs
      document
        .getElementById("pairSearchInput")
        .addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          document.querySelectorAll(".crypto-pair").forEach((pair) => {
            const pairName = pair.textContent.toLowerCase();
            if (pairName.includes(searchTerm)) {
              pair.style.display = "inline-block";
            } else {
              pair.style.display = "none";
            }
          });
        });

      // Clear search button
      document
        .getElementById("clearSearchBtn")
        .addEventListener("click", function () {
          document.getElementById("pairSearchInput").value = "";
          document.querySelectorAll(".crypto-pair").forEach((pair) => {
            pair.style.display = "inline-block";
          });
        });

      // Add this event listener for clearing fetch logs
      document
        .getElementById("clearFetchLogsBtn")
        .addEventListener("click", function () {
          document.getElementById("fetchLogs").textContent = "";
        });

      document
        .getElementById("reloadFilesBtn")
        .addEventListener("click", function () {
          loadExistingDataFiles();
        });

      function extractDateRange(filename) {
        try {
          // Try to extract date range from filename (typical format: SYMBOL_USDT_01-January-2023_to_31-January-2023.csv)
          if (filename.includes("_to_")) {
            const parts = filename.split("_");
            let startDateIdx = -1;
            let endDateIdx = -1;

            // Find the "to" index
            for (let i = 0; i < parts.length; i++) {
              if (parts[i] === "to") {
                startDateIdx = i - 1;
                endDateIdx = i + 1;
                break;
              }
            }

            if (startDateIdx > 0 && endDateIdx < parts.length) {
              // Get start and end dates
              let startDate = parts[startDateIdx];
              // If extension is in the end date, remove it
              let endDate = parts[endDateIdx].replace(".csv", "");

              // Format dates for better readability
              if (startDate.includes("-") && endDate.includes("-")) {
                // Dates are already formatted as DD-Month-YYYY
                return `${startDate} to ${endDate}`;
              }
            }
          }

          return null; // Couldn't extract date range
        } catch (e) {
          console.warn("Error extracting date range:", e);
          return null;
        }
      }

      // Add this after the other button event handlers
      document.querySelectorAll(".delete-file-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const filename = this.getAttribute("data-filename");

          // Confirm deletion
          if (confirm(`Are you sure you want to delete ${filename}?`)) {
            // Send delete request
            fetch("/delete_file", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                filename: filename,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.error) {
                  alert(`Error: ${data.error}`);
                } else {
                  // Show success message
                  alert(`File deleted successfully`);
                  // Refresh the file list
                  loadExistingDataFiles();

                  // Also update the dropdowns
                  const btcSelect = document.getElementById("btcFileSelect");
                  const altSelect = document.getElementById("altFileSelect");

                  // Remove the deleted file from dropdowns if present
                  for (let i = 0; i < btcSelect.options.length; i++) {
                    if (btcSelect.options[i].value.includes(filename)) {
                      btcSelect.remove(i);
                      break;
                    }
                  }

                  for (let i = 0; i < altSelect.options.length; i++) {
                    if (altSelect.options[i].value.includes(filename)) {
                      altSelect.remove(i);
                      break;
                    }
                  }

                  // Update run button state
                  updateRunButton();
                }
              })
              .catch((error) => {
                alert(`Error: ${error}`);
              });
          }
        });
      });

      // Add this function at the end of your script
      function setupDeleteButtons() {
        document.querySelectorAll(".delete-file-btn").forEach((btn) => {
          // Remove any existing event listeners
          btn.replaceWith(btn.cloneNode(true));
        });

        // Add fresh event listeners
        document.querySelectorAll(".delete-file-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const filename = this.getAttribute("data-filename");

            // Confirm deletion
            if (confirm(`Are you sure you want to delete ${filename}?`)) {
              // Send delete request
              fetch("/delete_file", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  filename: filename,
                }),
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.error) {
                    alert(`Error: ${data.error}`);
                  } else {
                    // Show success message
                    alert(`File deleted successfully`);
                    // Refresh the file list
                    loadExistingDataFiles();

                    // Also update the dropdowns
                    const btcSelect = document.getElementById("btcFileSelect");
                    const altSelect = document.getElementById("altFileSelect");

                    // Remove the deleted file from dropdowns if present
                    for (let i = 0; i < btcSelect.options.length; i++) {
                      if (btcSelect.options[i].value.includes(filename)) {
                        btcSelect.remove(i);
                        break;
                      }
                    }

                    for (let i = 0; i < altSelect.options.length; i++) {
                      if (altSelect.options[i].value.includes(filename)) {
                        altSelect.remove(i);
                        break;
                      }
                    }

                    // Update run button state
                    updateRunButton();
                  }
                })
                .catch((error) => {
                  alert(`Error: ${error}`);
                });
            }
          });
        });
      }

      // Global event listener for View Results button
      document
        .getElementById("viewResultsBtn")
        .addEventListener("click", function () {
          // Always open the same URL - simple and reliable
          window.open("/results/", "_blank");
        });

      // Override the checkAnalysisResult function to also update the strategy button
      checkAnalysisResult = function () {
        if (!analysisComplete) return;

        const loader = document.getElementById("analysisLoader");
        const resultDiv = document.getElementById("analysisResult");
        const logCard = document.getElementById("logCard");
        const logsDiv = document.getElementById("analysisLogs");

        fetch("/analysis_result")
          .then((response) => response.json())
          .then((data) => {
            loader.style.display = "none";

            if (data.status === "complete") {
              // Success message
              resultDiv.innerHTML = `
                <div class="alert alert-success">
                  Analysis complete! You can now view the results or generate a strategy.
                </div>
              `;

              // Add a final completion message to logs
              logsDiv.textContent +=
                "✅ Analysis completed successfully! Results are ready to view.\n";
              logsDiv.textContent +=
                "------------------------------------------------\n";

              // Enable the generate strategy button
              document.getElementById("generateStrategyBtn").disabled = false;

              // Highlight strategy section
              setTimeout(() => {
                document.querySelector(".card:nth-child(4)").scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                });

                // Highlight strategy section briefly
                const strategyCard =
                  document.querySelector(".card:nth-child(4)");
                strategyCard.style.transition = "box-shadow 0.5s ease";
                strategyCard.style.boxShadow =
                  "0 0 15px rgba(0, 123, 255, 0.7)";

                setTimeout(() => {
                  strategyCard.style.boxShadow = "";
                }, 2000);
              }, 1000);
            } else {
              resultDiv.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
            }

            // Close log stream but keep the logs visible
            if (logSource) logSource.close();
          })
          .catch((error) => {
            loader.style.display = "none";
            resultDiv.innerHTML = `<div class="alert alert-danger">Error checking result: ${error}</div>`;
            logsDiv.textContent += `Error: ${error}\n`;
            if (logSource) logSource.close();
          });
      };

      // Add tooltips for strategy options
      const tooltips = {
        momentum: "Focuses on rapid price changes following BTC movements",
        pattern:
          "Uses technical chart patterns from BTC to predict altcoin movements",
        ml: "Leverages machine learning model results for most accurate predictions",
      };

      document
        .getElementById("strategyType")
        .addEventListener("change", function () {
          const strategyType = this.value;
          const infoElement = document.createElement("div");
          infoElement.className = "alert alert-info mt-2";
          infoElement.innerHTML = tooltips[strategyType];

          // Remove existing info element if present
          const existingInfo = this.parentNode.querySelector(".alert");
          if (existingInfo) existingInfo.remove();

          // Add new info element
          this.parentNode.appendChild(infoElement);
        });

      // Replace the Claude API check section with this:
      fetch("/check_claude_api")
        .then((response) => response.json())
        .then((data) => {
          const claudeCheckbox = document.getElementById("useClaudeAI");
          const generateBtn = document.getElementById("generateStrategyBtn");

          if (!data.available) {
            // Disable both the checkbox and generate button
            claudeCheckbox.disabled = true;
            claudeCheckbox.checked = false;
            generateBtn.disabled = true;

            // Add warning to the strategy card
            const strategyResult = document.getElementById("strategyResult");
            strategyResult.innerHTML = `
              <div class="alert alert-warning">
                <strong>API Key Required:</strong> Claude AI is required for strategy generation. 
                Please set the ANTHROPIC_API_KEY environment variable to enable this feature.
              </div>
            `;
          }
        })
        .catch(() => {
          // Handle error case
          const claudeCheckbox = document.getElementById("useClaudeAI");
          const generateBtn = document.getElementById("generateStrategyBtn");

          claudeCheckbox.disabled = true;
          claudeCheckbox.checked = false;
          generateBtn.disabled = true;

          const warningElement = document.createElement("div");
          warningElement.className = "text-danger small mt-1";
          warningElement.textContent =
            "Claude API connection failed. Please check your server configuration.";
          claudeCheckbox.parentNode.appendChild(warningElement);
        });

      // Save strategy preferences in localStorage
      function saveStrategyPreferences() {
        const preferences = {
          strategyType: document.getElementById("strategyType").value,
          riskPerTrade: document.getElementById("riskPerTrade").value,
          useStopLoss: document.getElementById("useStopLoss").checked,
          stopLossPercent: document.getElementById("stopLossPercent").value,
          useTakeProfit: document.getElementById("useTakeProfit").checked,
          takeProfitPercent: document.getElementById("takeProfitPercent").value,
          useClaudeAI: document.getElementById("useClaudeAI").checked,
        };

        localStorage.setItem(
          "strategyPreferences",
          JSON.stringify(preferences)
        );
      }

      // Load strategy preferences from localStorage
      function loadStrategyPreferences() {
        const savedPrefs = localStorage.getItem("strategyPreferences");
        if (savedPrefs) {
          const preferences = JSON.parse(savedPrefs);

          document.getElementById("strategyType").value =
            preferences.strategyType;
          document.getElementById("riskPerTrade").value =
            preferences.riskPerTrade;
          document.getElementById("riskValue").textContent =
            preferences.riskPerTrade + "%";
          document.getElementById("useStopLoss").checked =
            preferences.useStopLoss;
          document.getElementById("stopLossPercent").value =
            preferences.stopLossPercent;
          document.getElementById("useTakeProfit").checked =
            preferences.useTakeProfit;
          document.getElementById("takeProfitPercent").value =
            preferences.takeProfitPercent;

          // Only set Claude AI if it's not disabled
          const claudeCheckbox = document.getElementById("useClaudeAI");
          if (!claudeCheckbox.disabled) {
            claudeCheckbox.checked = preferences.useClaudeAI;
          }
        }
      }

      // Save preferences when they change
      document
        .querySelectorAll(
          "#strategyType, #riskPerTrade, #useStopLoss, #stopLossPercent, #useTakeProfit, #takeProfitPercent, #useClaudeAI"
        )
        .forEach((element) => {
          element.addEventListener("change", saveStrategyPreferences);
        });

      // Load preferences when page loads
      window.addEventListener("DOMContentLoaded", loadStrategyPreferences);

      // Add keyboard shortcut (Alt+G) for generating strategy
      document.addEventListener("keydown", function (e) {
        if (
          e.altKey &&
          e.key === "g" &&
          !document.getElementById("generateStrategyBtn").disabled
        ) {
          document.getElementById("generateStrategyBtn").click();
        }
      });

      // Add this event listener to your JavaScript
      document
        .getElementById("riskPerTrade")
        .addEventListener("input", function () {
          document.getElementById("riskValue").textContent = this.value + "%";
        });

      // Add function to enable/disable the strategy generator button
      function updateStrategyButton() {
        const generateBtn = document.getElementById("generateStrategyBtn");

        // Enable the button if analysis is complete
        fetch("/analysis_result")
          .then((response) => response.json())
          .then((data) => {
            generateBtn.disabled = !(data.status === "complete");
          })
          .catch(() => {
            generateBtn.disabled = true;
          });
      }

      // Add event listener for generate strategy button
      document
        .getElementById("generateStrategyBtn")
        .addEventListener("click", function () {
          const strategyLoader = document.getElementById("strategyLoader");
          const strategyResult = document.getElementById("strategyResult");

          strategyLoader.style.display = "block";
          strategyResult.innerHTML = "";

          // Get strategy parameters
          const params = {
            strategy_type: document.getElementById("strategyType").value,
            risk_per_trade: document.getElementById("riskPerTrade").value,
            use_stop_loss: document.getElementById("useStopLoss").checked,
            stop_loss_percent: document.getElementById("stopLossPercent").value,
            use_take_profit: document.getElementById("useTakeProfit").checked,
            take_profit_percent:
              document.getElementById("takeProfitPercent").value,
            use_claude_ai: document.getElementById("useClaudeAI").checked,
          };

          // Send request to generate strategy
          fetch("/generate_strategy", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(params),
          })
            .then((response) => response.json())
            .then((data) => {
              strategyLoader.style.display = "none";

              if (data.error) {
                strategyResult.innerHTML = `
              <div class="alert alert-danger">
                <strong>Error:</strong> ${data.error}
              </div>`;
              } else {
                strategyResult.innerHTML = `
              <div class="alert alert-success">
                <strong>Success!</strong> Strategy generated successfully.
              </div>
              <div class="d-flex gap-2 mt-3">
                <a href="${data.download_url}" class="btn btn-primary" download>
                  Download Pine Script Strategy
                </a>
                <a href="${data.view_url}" class="btn btn-outline-secondary" target="_blank">
                  View Code
                </a>
              </div>`;
              }
            })
            .catch((error) => {
              strategyLoader.style.display = "none";
              strategyResult.innerHTML = `
            <div class="alert alert-danger">
              <strong>Error:</strong> ${error}
            </div>`;
            });
        });

      // Add this function to load available reports
      function loadAvailableReports() {
        const reportSelect = document.getElementById("reportSelect");

        // Show loading state
        reportSelect.innerHTML = '<option value="">Loading reports...</option>';

        fetch("/list_reports")
          .then((response) => response.json())
          .then((data) => {
            if (data.reports && data.reports.length > 0) {
              reportSelect.innerHTML =
                '<option value="">-- Select a report --</option>';

              data.reports.forEach((report) => {
                const option = document.createElement("option");
                option.value = report.path;
                option.textContent = report.name;
                reportSelect.appendChild(option);
              });
            } else {
              reportSelect.innerHTML =
                '<option value="">No reports available</option>';
            }
          })
          .catch((error) => {
            reportSelect.innerHTML =
              '<option value="">Error loading reports</option>';
            console.error("Error loading reports:", error);
          });
      }

      // Call this when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadAvailableReports();
      });

      // Add event listener for the refresh reports button
      document
        .getElementById("loadReportsBtn")
        .addEventListener("click", loadAvailableReports);

      // Modify the generate strategy button event listener
      document
        .getElementById("generateStrategyBtn")
        .addEventListener("click", function () {
          const reportPath = document.getElementById("reportSelect").value;
          if (!reportPath) {
            alert("Please select an analysis report first");
            return;
          }

          const strategyLoader = document.getElementById("strategyLoader");
          const strategyResult = document.getElementById("strategyResult");

          strategyLoader.style.display = "block";
          strategyResult.innerHTML = "";

          // Get strategy parameters
          const params = {
            report_path: reportPath,
            strategy_type: document.getElementById("strategyType").value,
            risk_per_trade: document.getElementById("riskPerTrade").value,
            use_stop_loss: document.getElementById("useStopLoss").checked,
            stop_loss_percent: document.getElementById("stopLossPercent").value,
            use_take_profit: document.getElementById("useTakeProfit").checked,
            take_profit_percent:
              document.getElementById("takeProfitPercent").value,
          };

          // Send request to generate strategy
          fetch("/generate_strategy", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(params),
          })
            .then((response) => response.json())
            .then((data) => {
              strategyLoader.style.display = "none";

              if (data.error) {
                strategyResult.innerHTML = `
              <div class="alert alert-danger">
                <strong>Error:</strong> ${data.error}
              </div>`;
              } else {
                strategyResult.innerHTML = `
              <div class="alert alert-success">
                <strong>Success!</strong> Strategy generated successfully using Claude AI.
              </div>
              <div class="d-flex gap-2 mt-3">
                <a href="${data.download_url}" class="btn btn-primary" download>
                  Download Pine Script Strategy
                </a>
                <a href="${data.view_url}" class="btn btn-outline-secondary" target="_blank">
                  View Code
                </a>
              </div>`;
              }
            })
            .catch((error) => {
              strategyLoader.style.display = "none";
              strategyResult.innerHTML = `
            <div class="alert alert-danger">
              <strong>Error:</strong> ${error}
            </div>`;
            });
        });
    </script>
  </body>
</html>
